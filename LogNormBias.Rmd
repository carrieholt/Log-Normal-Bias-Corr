---
title: "LogNormBias"
author: "Carrie Holt"
date: "November 3, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(TMB)
#library(tmbstan)
source("Functions.R")
dyn.load(dynlib("Single_Stock_Ricker"))

```

## PART 1: Log-Normal Bias correction when simulated data

SC "I am not convinced that this analysis answers the actual concern I raised, which was about making sure that the expected value of projected recruitments matched the curve used to generate them."  

Similarly, our concern is that the data being simulated relfect the underlying curve that they are generated from. However, we argue that when the Ricker parameters are estimated assuming median predicted values without the +sig2/2 correction in the log-likelihood (as described in the Working Paper), then the simulated data should not include the the -sig2/2 correction to match the underlying curve. 

To explore the impacts of bias correction, we generate data from a known Ricker relationship including a log-normal bias correction and then estimate Ricker parameter from those data and compare to the "true" curve. We then repeat these 2 steps without a log-normal bias corretion when generationg the data.

1a. First, random "true" data were generated from known Ricker parameters with a -sig2/2 bias correction. Within the Sim_Ricker_SR_Data() function, the option lnorm_corr=F, specifies whether the -sig2/2 correction is applied or not.

```{r}
set.seed(1004)
SimData <- Sim_Ricker_SR_Data(leng=50, age=4, Sig_Ricker = 0.8, true_a = rnorm(1, 5, 2), true_b=1/100000,
                        hr_min = 0.2, hr_max = 0.8, lnorm_corr = T)

SimDataDF <- data.frame(S = round(SimData$S), R = (SimData$R), Year = 1:length(SimData$S))

ggplot(SimDataDF, aes(x=S, y=R)) + geom_point() + coord_fixed()

# A dataframe is created to store true and fitted values
DataDF <- SimDataDF[, c("S", "R", "Year")]
DataDF$Fit <- SimData$true_a * DataDF$S * exp( -SimData$true_b * DataDF$S ) 
DataDF$Mod <- "True"
DataDF$CI_low <- DataDF$CI_up  <-  DataDF$Pred <- DataDF$Pred_low <- DataDF$Pred_up <- DataDF$Fit

```


2a. MLE Ricker parameters were estimated from "true" data

MLEs of Ricker parmeters were etimated in TMB. The likelihood minimizes the difference between observed and median predicted values, as described in the Working paper.
Within the RunRicker() function, the "BiasCorr=F" option means that the likelihood in TMB is:  
ans += -dnorm(logR(i), logR_Fit(i), sigma, true); and
logR_Fit(i) = logA + log(S(i)) -  S(i)/Smax;

```{r, echo=FALSE}

TMB_No_Prior <- RunRicker(Data = SimDataDF, 
                          Fitting_SW = "TMB", 
                          Priors = F, BiasCorr=F, Name = "TMB_No_Prior")

All_Ests <- bind_rows(DataDF, TMB_No_Prior[[1]])

# Now plot all to compare 
ggplot(data = All_Ests, aes(x=S, y=Fit, ymin = CI_low, ymax = CI_up, col = Mod, fill= Mod)) +
  geom_line(size = 1.5) +
  geom_ribbon( alpha = 0.1) +
  geom_point(aes(x=S, y=R), col = "black") +
  #geom_ribbon(aes(x=S, y=Pred, ymin = Pred_low, ymax = Pred_up, fill= Mod), 
  #            alpha = 0.05) +
  scale_color_discrete(name = "", labels = c("Estimated curve w/o\nbias correction in LL", "True")) + 
  guides(fill = FALSE)  +
  xlab("Spawners") + 
  ylab("Recruitment") +
  theme_bw(base_size=16)

```

In this figure the estiamted curve is lower than the "true" curve. They do no match because the simulations include a bias correction, but the estimation does not.  If we were to further simulate data from the estimated curve with a log-normal -sig2/2 bias correction and then estimate the parameters of the curve based on those new simulated data using the LL as described in our working paper, the curve derived from those simulated data would again be lower than the red curve.



We then repeated the steps, but did not include a bias correction when generating the data.

1b (without bias correction). We generate "true" data without a -sig2/2 bias correction.


```{r}
set.seed(1004)
SimData <- Sim_Ricker_SR_Data(leng=50, age=4, Sig_Ricker = 0.8, true_a = rnorm(1, 5, 2), true_b=1/100000,
                        hr_min = 0.2, hr_max = 0.8, lnorm_corr = F)

SimDataDF <- data.frame(S = round(SimData$S), R = (SimData$R), Year = 1:length(SimData$S))

ggplot(SimDataDF, aes(x=S, y=R)) + geom_point() + coord_fixed()

DataDF <- SimDataDF[, c("S", "R", "Year")]
DataDF$Fit <- SimData$true_a * DataDF$S * exp( -SimData$true_b * DataDF$S ) 
DataDF$Mod <- "True"
DataDF$CI_low <- DataDF$CI_up  <-  DataDF$Pred <- DataDF$Pred_low <- DataDF$Pred_up <- DataDF$Fit


```

2b (without bias corretion). MLE of the Ricker parameters were then estimated using using the same likelihood as above. 


```{r}
TMB_No_Prior <- RunRicker(Data = SimDataDF, 
                          Fitting_SW = "TMB", 
                          Priors = F, BiasCorr=F, Name = "TMB_No_Prior")

All_Ests <- bind_rows(DataDF, TMB_No_Prior[[1]])

# Now plot all to compare 
ggplot(data = All_Ests, aes(x=S, y=Fit, ymin = CI_low, ymax = CI_up, col = Mod, fill= Mod)) +
  geom_line(size = 1.5) +
  geom_ribbon( alpha = 0.1) +
  geom_point(aes(x=S, y=R), col = "black") +
  #geom_ribbon(aes(x=S, y=Pred, ymin = Pred_low, ymax = Pred_up, fill= Mod), 
  #            alpha = 0.05) +
  scale_color_discrete(name = "", labels = c("Estimated curve w/o\nbias correction in LL", "True")) + 
  guides(fill = FALSE)  +
  xlab("Spawners") + 
  ylab("Recruitment") +
  theme_bw(base_size=16)
```
Here, the curve estimated from the generated data matches the underlying "true" curve.



## PART 2: Revising estimation procedure

The estimation procedure in the working paper is based on maximum likelihood, and fits the data to the median predicted recruitment in the log-likelhood. An alternative is to fit the data to the expected value of the predicted recruitment by adding the -sig2/2 correction into the predicted value. In TMB the likelihood is:

ans += -dnorm(logR(i) - ( logR_Fit(i) - pow(sigma,2)/Type(2) ), Type(0), sigma, true);
OR, equivalently,
ans += -dnorm(logR(i)-logR_Fit(i), -pow(sigma,2)/Type(2), sigma, true); 

3. As before, data were generated with a log-normal bias correction (as in 1a). Second, the Ricker parameters were estimated with the log-normal bias correction in the LL.

```{r}
set.seed(1004)
SimData <- Sim_Ricker_SR_Data(leng=50, age=4, Sig_Ricker = 0.8, true_a = rnorm(1, 5, 2), true_b=1/100000,
                        hr_min = 0.2, hr_max = 0.8, lnorm_corr = T)

SimDataDF <- data.frame(S = round(SimData$S), R = (SimData$R), Year = 1:length(SimData$S))

ggplot(SimDataDF, aes(x=S, y=R)) + geom_point() + coord_fixed()

# A dataframe is created to store true and fitted values
DataDF <- SimDataDF[, c("S", "R", "Year")]
DataDF$Fit <- SimData$true_a * DataDF$S * exp( -SimData$true_b * DataDF$S ) 
DataDF$Mod <- "True"
DataDF$CI_low <- DataDF$CI_up  <-  DataDF$Pred <- DataDF$Pred_low <- DataDF$Pred_up <- DataDF$Fit


TMB_No_Prior <- RunRicker(Data = SimDataDF, 
                          Fitting_SW = "TMB", 
                          Priors = F, BiasCorr=T, Name = "TMB_No_Prior")

All_Ests <- bind_rows(DataDF, TMB_No_Prior[[1]])

# Now plot all to compare 
ggplot(data = All_Ests, aes(x=S, y=Fit, ymin = CI_low, ymax = CI_up, col = Mod, fill= Mod)) +
  geom_line(size = 1.5) +
  geom_ribbon( alpha = 0.1) +
  geom_point(aes(x=S, y=R), col = "black") +
  #geom_ribbon(aes(x=S, y=Pred, ymin = Pred_low, ymax = Pred_up, fill= Mod), 
  #            alpha = 0.05) +
  scale_color_discrete(name = "", labels = c("Estimated curve with\nbias correction in LL", "True")) + 
  guides(fill = FALSE)  +
  xlab("Spawners") + 
  ylab("Recruitment") +
  theme_bw(base_size=16)

```

Now the estimated matches the true curve again.



I agree that the estimation methods for deriving recovery targets should match the approach for estimating parmaters for the projections and generating data in projections. Lauren is further investigating the methods for deriving recoery targets in the  (2014) WSP assessment, which were not well documented.


