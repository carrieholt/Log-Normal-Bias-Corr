---
title: "Log Normal Bias Correction"
author: "Carrie Holt and Brooke Davis"
date: "November 12, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(TMB)
library(tmbstan)
# The following files are adapted from Brooke Davis
source("Functions.R") 

dyn.unload(dynlib("Single_Stock_Ricker"))
# compile("Single_Stock_Ricker.cpp")
# dyn.load(dynlib("Single_Stock_Ricker"))

```

To satisfy elements 13 and 15 of the RPA forward population projections for DU2 are used in a 3 step procedure to evaluate the effects of management options and natural sources of uncertainty on the probability of achieving recovery targets: These are:

(1)	Estimate key parameters for the population from existing data. 

(2)	Use those parameters in a forward projection model. In the working paper it is assumed that the parameters are constant in time, and known with certainty. For the purposes of this analysis we will call them "true"" parameters within the operating model.

(3)	Compare projections to recovery targets. Targets consist of abundance benchmarks derived from an earlier analysis and trends in abundance, based on COSEWIC criteria.

__Step 1: Parameter estimation__

In the first step, parameters for a Ricker stock-recruit model were estimated using 30 years of data from the Harrison population. As described in Section 5.1 of the working paper, we used a Ricker model with log-normal deviates $e^\omega$ (subscripts for time are deleted for clarity). For the purposes of investigating impacts of the log-normal bias correction, we focused on estimation of the standard, rather than time-varying Ricker model.

(Eqn. 1)	$$R = α S e^{–bS} e^{\omega}$$

We linearized the equation to:

(Eqn. 2)	$$log(R) = log(S) + log(α) – bS + \omega$$

and estimated parameters that minimized the difference predicted log(*R*) and observed log(*R*). When parameters are estimated this way the Ricker function describes the median of the distribution of recruitments at any S (Ricker 1975). Because the mean or expected value of a log-normal distribution is $e^{σ^2/2}$, not 1, the median model must be adjusted in order to predict mean or average recruitment.  Hilborn and Walters (1992) recommended applying a bias-correction to the productivity estimate derived from equation (2) so that the resulting parameters generate mean or expected values of recruitment. This can be accomplished as:

(Eqn. 3)	$$R = αSe^{-bS}e^{σ^2/2}$$

Or by folding the adjustment into the productivity parameter:

(Eqn. 4) $$log(α)’ = log(α) + σ^2/2$$

Note that an adjustment of the *b* parameter is required in the alternative formulation of the Ricker model (which is not used here, but see equations 7.6.3 and 7.6.4 and Table 7.2 of Hilborn and Walters 1992). 

An alternative approach to that of Hilborn and Walters (1992) which is used commonly in stock assessments on marine fisheries is to estimate the parameters of the Ricker model assuming predicted recruitment $R'$, equal to $R' = R e^{-σ^2/2}$ within the estimation procedure (Methot and Taylor 2011), where *R* is calculated from equation (1) and is the mean of the log-normal deviations here. The end result of these two approaches is the same: Ricker parameters that provide the expected or mean recruitment. <!--CH comment: Methot and Taylor (2011) further explore an additional scalar, b, to revise the -sig2/2 log-normal bias adjusment annually depending on the information about recrutiment deviations in the data-->

Here predictions of median recruitment from the median model (Eqn. 1) are insensitive to $\sigma$, however, predictions of mean recruitment from the mean model (Eqn. 3) will depend on the estimated $\sigma$.

__Step 2: Forward projections__

__2.1 Original working paper approach__

In forward projections, a Ricker model with parameters from Step 1 were used in the DU2 projection model to develop spawner trajectories. As is typical in salmon simulations, in the working paper the median model (Eqn. 1), with the log-normal error term was used for generating annual recruitments.

It is expected that the recruitments for a given *S* generated by this process would have a median of *R* as described by the model, and a log-normal distribution that would result in the mean recruitment being described by the mean model (Eqn. 3).

Thus the characteristics of the simulated recruitments used in the projection model will match expectations based on the generating model (Eqn. 1; the median Ricker model described by parameters $\alpha$, *b*, and $\sigma$ that are estimated from Harrison data). Mean simulated recruitment at a given *S* will be the same as the mean *R* predicted by the mean-based Ricker model (Eqn. 3).

__2.2 An alternative formulation based on mean recruitment__

At the July meeting it was recommended that a negative $-σ^2/2$ bias correction be applied to the predictions of annual recruitment made in the forward projections as:

(Eqn. 5)	$$R’ = R e^{-σ^2/2}$$ 

It was mentioned that applying this correction in forward projections is consistent with other marine fish stock assessments. The bias correction assumes that the stock-recruitment parameters provide the mean predicted recruitment and the correction is necessary because the mean of the log-normal error term used in the simulations is greater than one ($E[e^\omega]>1$). The bias correction ensures the mean of the simulated recruitments is *R*, the value predicted from the mean recruitment model used as the basis of the simulations. To implement this approach, parameters should provide mean, not median, predicted recruitments, which can be estimated as in Hilborn and Walters (1992) (rearranged in Eqn. 6 below), or by including predicted recruitments equal to Equation (5) within the estimation procedure. This latter approach was used in the simulation excercise below.

(Eqn. 6)	$$R = αSe^{-bS}e^{σ^2/2}e^\omega$$  or 
$$R = α’Se^{-bS}e^\omega$$

This is consistent with the approach used for other taxa where the parameters are described in terms of mean, rather than median, quantities.

Then individual predicted *R* values within the projection would be corrected using equation (5). Now the mean of corrected annual recruitments ($R’$) for a given *S* will be the same as those predicted by the mean model (Eqn. 6).

Inspection of equations (5) and (6) shows that the net effect of simulating with the mean-based Ricker model (which increases recruitments over those generated by the median model), then correcting simulated *R* values using equation (6) (which decreases recruitments by the same amount) will yield exactly the same results as using the median model and not employing the correction factor, as was done originally in the working paper, and is generally done in salmon projection modelling.


__2.3 A biased, bias-correction procedure__

When the use of the bias-correction factor was originally proposed in July, an initial round of projections was run by simulating recruitment using the standard median model, then reducing recruitments using the proposed correction.
To recall, here is the median model used to generate recruitment, and the subsequent bias correction: 

(Eqn. 7)	$$R = αSe^{–bS}e^\omega$$

(Eqn. 8)	$$R’ = Re^{-σ^2/2}$$ 

The net effect of these 2 steps is that the mean of *R’* will be *R*, however, *R* is the median recruitment as generated by equation (7). This will induce an strong negative bias in the distribution of *R* at a given *S*. In this case the simulated R’s that feed into the projection model do not have the desired properties as defined by the true parameters of equation (7). 

__2.4 Conclusion__

The approaches outlined in 2.1 and 2.2 achieve the desired result, that the characteristics of the distribution of simulated R values at a given S match expectations. Method 2.1 is the typical approach for salmon modelling; 2.2 is more consistent with practise for other taxa, but mathematically they are the same. Method 2.3 is biased and should not be used. A simulation excercise below illustrates these conclusions.

An issue that is outstanding is a consistent approach for the calculation of abundance-based benchmarks. The two commonly used WSP benchmarks ($S_{gen}$ and $0.8\times S_{MSY}$) rely on Ricker parameters and the most common approach taken to date has been to use the median-based parameters for their computation.

In the working paper, WSP benchmarks for DU2 that had been previously developed and published were used for the abundance-based components of the recovery targets. Proposed benchmarks in the RPA are characterized in the terms of reference as “candidate” and can could be revised in the future if required.  However, simulation results to date suggest the trend indicator, that is not reliant on stock-recruit parameters, plays a greater role in meeting the lower recovery target so the main conclusions resulting from the projections on the ability to achieve that target should not be sensitive to small changes in the WSP benchmarks.




## Simulations to Expore Impacts of Log-Normal Bias Correction 


To explore the impacts of the log-normal bias correction, we simulated the three methods described above. In the first method (__Method 2.1__: the original working paper approach), we assumed that we had estimated median Ricker parameters from the analysis of existing data, and then generated data using those parameters within a simple Ricker model without any bias correction (referred to as the "operating model"). To evaluate the characteristics of the simulated data, we estimated Ricker parameters from the data, again without bias correction. We expect the estimated parameters to be similar to those used for the simulations in the operating model. Although the projection model for DU2 in the working paper is more complex as it assumes age structure, and age-specific harvest, our approach captures the main source of variability in the projection model. Also, whereas in the working paper, Ricker parameters were first estimated and then recruitment was projected, in this excercise, we reverse the order by simulating data based on assumed parameters in an operating model and then estimating the underlying parameters. First we simulate a single MC trial for each method using the same random seed; then we iterate over multilple MC trials. Specifically, for Method 2.1 we assumed,

 + Operating Model = OM1: No Bias Corr
 
 + Estimator =  No Bias Corr

In __Method 2.2__, we repeated these 2 steps but assumed mean parameters from the analysis of existing data and applied the bias correction when generating data in the operating model. We then estimated Ricker parameters using an estimation approach based on mean recruitment that accounted for the log-normal bias. This represents an alternative formulation based on mean recruitment.

 + Operating Model = OM2: Bias Corr
 
 + Estimator =  Bias Corr

In __Method 2.3__, we applied the bias correction when generating data in the operating model. We then estimated parameters of the Ricker model using the original estimation procedure for the median recruitment without a log-normal bias correction. This is a biased approach due to the inconsistency between estimation and data generation, comparable to that attempted in the revision of the working paper. 
 
 + Operating Model = OM3: Bias Corr
 
 + Estimator =  No Bias Corr

The OMs for each method have the same underlying Ricker parameters that were chosen to reflect Harrison DU dynamics. They differ only in the generation of data (with or without log-normal bias correction). Therefore in the plots, the curves from all Operating Models are simply labeled "OM".

__Method 2.1__

Step 1. First, random data were generated from known Ricker parameters without a $-\sigma^2/2$ bias correction. Within the Sim_Ricker_SR_Data() function, the option lnorm_corr=F, specifies whether the $-\sigma^2/2$  correction is applied or not.

```{r}
set.seed(1004)
SimData <- Sim_Ricker_SR_Data(leng=50, age=4,  Sig_Ricker = 0.76, true_a = 1.93, true_b=1/159744,
                        hr_min = 0.25, hr_max = 0.35, lnorm_corr = F)

SimDataDF <- data.frame(S = round(SimData$S), R = (SimData$R), Year = 1:length(SimData$S))

ggplot(SimDataDF, aes(x=S, y=R)) + geom_point() + coord_fixed()

# A dataframe is created to store true and fitted values for the OM
DataDF <- SimDataDF[, c("S", "R", "Year")]
DataDF$Fit <- SimData$true_a * DataDF$S * exp( -SimData$true_b * DataDF$S ) 
DataDF$Mod <- "True"
DataDF$CI_low <- DataDF$CI_up  <-  DataDF$Pred <- DataDF$Pred_low <- DataDF$Pred_up <- DataDF$Fit

```


Step 2.  Ricker parameters were estimated from the data 

Median posterior Ricker parmeters were estimated within TMBstan, using diffuse priors (see Functions.R code for details). Note, we also ran the simluation excercises using maximum liklihood estimation within TMB and found similar results. Within the TMB code used by TMBstan (Single_StockRicker.cpp), the predicted values in the likelihood represent median values. In TMB, the likelihood is written as:

logR_Fit(i) = logA + log(S(i)) -  S(i)/Smax;

ans += -dnorm(logR(i), logR_Fit(i), sigma, true);


Within the RunRicker() function, this is achieved with the "BiasCorr=F" option. 

```{r results='hide', warning=FALSE}

TMBstan_Prior <- RunRicker(Data = SimDataDF, 
                          Fitting_SW = "tmbstan", 
                          Priors = T, BiasCorr=F, Name = "TMBstan_Prior")

All_Ests <- suppressWarnings( bind_rows(DataDF, TMBstan_Prior[[1]]) )

# Now plot all to compare 
ggplot(data = All_Ests, aes(x=S, y=Fit, ymin = CI_low, ymax = CI_up, col = Mod, fill= Mod)) +
  geom_line(size = 1.5) +
  geom_ribbon( alpha = 0.1) +
  geom_point(aes(x=S, y=R), col="black") +
  #geom_ribbon(aes(x=S, y=Pred, ymin = Pred_low, ymax = Pred_up, fill= Mod), 
  #            alpha = 0.05) +
  scale_color_discrete(name = "", labels = c("Estimator =\nNo Bias Corr", "OM")) + 
  guides(fill = FALSE)  +
  xlab("Spawners") + 
  ylab("Recruitment") +
  theme_bw(base_size=16)



```

In this figure, the estimated curve matches the curve from the Operating Model (OM). The thin red lines represent the 2.5th and 97.5th percentiles of the posterior distribution of predicted recruits.


__Method 2.2__
We then repeated the steps, but included a bias correction when generating the data and when estimating parameters.

Step 1. We generated data with a -sig2/2 bias correction.


```{r}
set.seed(1004)
SimData <- Sim_Ricker_SR_Data(leng=50, age=4,  Sig_Ricker = 0.76, true_a = 1.93, true_b=1/159744,
                        hr_min = 0.25, hr_max = 0.35, lnorm_corr = T)

SimDataDF <- data.frame(S = round(SimData$S), R = (SimData$R), Year = 1:length(SimData$S))

ggplot(SimDataDF, aes(x=S, y=R)) + geom_point() + coord_fixed()

DataDF <- SimDataDF[, c("S", "R", "Year")]
DataDF$Fit <- SimData$true_a * DataDF$S * exp( -SimData$true_b * DataDF$S ) 
DataDF$Mod <- "True"
DataDF$CI_low <- DataDF$CI_up  <-  DataDF$Pred <- DataDF$Pred_low <- DataDF$Pred_up <- DataDF$Fit


```

Step 2. Ricker parameters were then estimated in tmbstan with a bias correction, where the predicted values represented mean recruitment. The likelihood in the TMB code is:

ans += -dnorm(logR(i) - ( logR_Fit(i) - pow(sigma,2)/Type(2) ), Type(0), sigma, true);

or, equivalently,

ans += -dnorm(logR(i)-logR_Fit(i), -pow(sigma,2)/Type(2), sigma, true); 

```{r results='hide', warning=FALSE}
TMBstan_Prior <- RunRicker(Data = SimDataDF, 
                          Fitting_SW = "tmbstan", 
                          Priors = T, BiasCorr=T, Name = "TMBstan_Prior")

All_Ests <- suppressWarnings( bind_rows(DataDF, TMBstan_Prior[[1]]) )

# Now plot all to compare 
ggplot(data = All_Ests, aes(x=S, y=Fit, ymin = CI_low, ymax = CI_up, col = Mod, fill= Mod)) +
  geom_line(size = 1.5) +
  geom_ribbon( alpha = 0.1) +
  geom_point(aes(x=S, y=R), col = "black") +
  #geom_ribbon(aes(x=S, y=Pred, ymin = Pred_low, ymax = Pred_up, fill= Mod), 
  #            alpha = 0.05) +
  scale_color_discrete(name = "", labels = c("Estimator = \nNo Bias Corr", "OM")) + 
  guides(fill = FALSE)  +
  xlab("Spawners") + 
  ylab("Recruitment") +
  theme_bw(base_size=16)
```

Here, the curve estimated from the generated data also matches the underlying curve from the OM.



__Method 2.3__

For this method, the data are generated with log-normal bias correction, but the parameters are estimated assuming median predicted recruitments. This represents a biased, bias-correction approach.

```{r results='hide', warning=FALSE}
set.seed(1004)
SimData <- Sim_Ricker_SR_Data(leng=50, age=4, Sig_Ricker = 0.76, true_a = 1.93, true_b=1/159744, 
                              hr_min = 0.25, hr_max = 0.35, lnorm_corr = T)

SimDataDF <- data.frame(S = round(SimData$S), R = (SimData$R), Year = 1:length(SimData$S))

ggplot(SimDataDF, aes(x=S, y=R)) + geom_point() + coord_fixed()

# A dataframe is created to store true and fitted values
DataDF <- SimDataDF[, c("S", "R", "Year")]
DataDF$Fit <- SimData$true_a * DataDF$S * exp( -SimData$true_b * DataDF$S ) 
DataDF$Mod <- "True"
DataDF$CI_low <- DataDF$CI_up  <-  DataDF$Pred <- DataDF$Pred_low <- DataDF$Pred_up <- DataDF$Fit


TMBstan_Prior <- RunRicker(Data = SimDataDF, 
                          Fitting_SW = "tmbstan", 
                          Priors = T, BiasCorr=F, Name = "TMBstan_Prior")

All_Ests <- suppressWarnings( bind_rows(DataDF, TMBstan_Prior[[1]]) )

# Now plot all to compare 
ggplot(data = All_Ests, aes(x=S, y=Fit, ymin = CI_low, ymax = CI_up, col = Mod, fill= Mod)) +
  geom_line(size = 1.5) +
  geom_ribbon( alpha = 0.1) +
  geom_point(aes(x=S, y=R), col = "black") +
  #geom_ribbon(aes(x=S, y=Pred, ymin = Pred_low, ymax = Pred_up, fill= Mod), 
  #            alpha = 0.05) +
  scale_color_discrete(name = "", labels = c("Estimator =\nBias Corr", "OM")) + 
  guides(fill = FALSE)  +
  xlab("Spawners") + 
  ylab("Recruitment") +
  theme_bw(base_size=16)

```

Here the estimated curve is negatively biased relative to the OM. 

## Iterate over multiple MC trials

We then iterated the generation of data and estimation of Ricker parameters over multiple Monte Carlo trials. We ran the model over the same 3 scenarios as above:

Method 2.1 = data are generated without log-normal bias correction, and without a correction in the estimation

Method 2.2 = data are generated with a log-normal bias corretion, and with a correction in the estimation

Method 2.3 = data are generated with log-normal bias correction, but without a correction in the estimation

For Scenario 2.1:

```{r eval=FALSE}
# This chunk of code takes 5-10 minutes to run if estimating Bayesian posteriors in tmbstan
ntrials <- 100
RicPars <- matrix(NA, ntrials, 4)

for (i in 1:ntrials) {
  SimData <- Sim_Ricker_SR_Data(leng=50, age=4, Sig_Ricker = 0.76, true_a = 1.93, true_b=1/159744, 
                              hr_min = 0.25, hr_max = 0.35, lnorm_corr = F)
  
  SimDataDF <- data.frame(S = round(SimData$S), R = (SimData$R), Year = 1:length(SimData$S))
  
  #ggplot(SimDataDF, aes(x=S, y=R)) + geom_point() + coord_fixed()
  
  # Create DF to store true and fitted values
  DataDF <- SimDataDF[, c("S", "R", "Year")]
  DataDF$Fit <- SimData$true_a * DataDF$S * exp( -SimData$true_b * DataDF$S ) 
  DataDF$Mod <- "True"
  DataDF$CI_low <- DataDF$CI_up  <-  DataDF$Pred <- DataDF$Pred_low <- DataDF$Pred_up <- DataDF$Fit
  
  # run using TMBstan
  # Switch BiasCorr between T and F and plot to see impact of bias correction in LL
  TMBstan_Prior <- RunRicker(Data = SimDataDF, 
                            Fitting_SW = "tmbstan", 
                            Priors = T, BiasCorr=F, Name = "TMBstan_Prior")
  
  Ests_quant <- apply ( as.data.frame(TMBstan_Prior$Ests) , 2, quantile, probs = c(0.025, 0.5, 0.975) )
  logA <- as.data.frame(Ests_quant)$logA[2] # median
  logSmax <- as.data.frame(Ests_quant)$logSmax[2] # median
  logSigma <- as.data.frame(Ests_quant)$logSigma[2] # median
  RicPars[i,] <- c(logA, logSmax, logSigma, TMBstan_Prior$Scale)  
}

colnames(RicPars) <- c("logA", "logSmax", "logSigma", "Scale")
write.csv(RicPars, "RicParsS1.csv")

```

The Ricker parameters for all MC trials were compiled in a dataframe, and parameter sets where productivity was less than replacement were removed

```{r}
# Set up data frame of Ricker paramters for all MC trials

RicPars <- read.csv("RicParsS1.csv")
RicPars <- as.data.frame(RicPars)
RicPars <- RicPars %>% mutate(Smax = exp(logSmax)*Scale) 

# Remove any MC trials with productivity less than 1 (logA < 0)

RicPars <- RicPars %>% filter(logA >= 0)
ntrialsTuned <- length (RicPars$logA)

```

We then calculated predicted recruitment for each parameter set, and extracted the median among MC trials (and 2.5th and 97.5th percentiles). These predicted recruits were plotted with the Ricker curve from the OM.

```{r, warning=FALSE}
# Calculate predicted recruitments for all MC trials along a range of spawner abundances
S <- NA
Rpred <- matrix(NA, 2000, ntrialsTuned)

for (i in 1:ntrialsTuned) {
  for (j in 1:2000){ #Assuming true smax ~ 100,000, and plot extends to 2 x Smax
    S[j] <- j*100
    Rpred[j,i] <-  exp( RicPars$logA[i] ) * S[j] * exp( -S[j] / RicPars$Smax[i] )
  }
}

Rpred_dist <- apply(Rpred, 1, quantile, probs = c(0.025, 0.5, 0.975))
Rpred_mean <- apply(Rpred, 1, mean) 


# Create a dataframe of these percentiles
EstAgg <- data.frame(S=S, Fit=Rpred_dist[2,], CI_low=Rpred_dist[1,], CI_up = Rpred_dist[3,])
EstAgg$Mod <- "TMBstan_Prior"

# The plot is very similar with mean of the distribiton of recruitments instead of the median
# EstAgg <- data.frame(S=S, Fit=Rpred_mean, CI_low=Rpred_dist[1,], CI_up = Rpred_dist[3,])


All_Ests <- bind_rows(DataDF, EstAgg)


# Now plot all to compare 
ggplot(data = All_Ests, aes(x=S, y=Fit, ymin = CI_low, ymax = CI_up, col = Mod, fill= Mod)) +
  geom_line(size = 1.5) +
  geom_ribbon( alpha = 0.1) +
  #geom_point(aes(x=S, y=R), col = "black") +
  scale_color_discrete(name = "", labels = c("Estimator =\nNo Bias Corr", "OM")) + 
  guides(fill = FALSE)  +
  xlab("Spawners") + 
  ylab("Recruitment") +
  xlim(0, 200000) +
  theme_bw(base_size=16)


```

Here the curves match. The thin red lines are the  2.5th and 97.5th percentiles of predicted recruits over 100 MC trials, derived from median posterior parameter estimates within each MC trial. 


For __Method 2.2__, data were generated with a log-normal bias correction, and with a correction in the estimation
```{r echo = FALSE, eval=FALSE}
# This code takes 5-10 minutes to run if estimating Bayesian posteriors in tmbstan
ntrials <- 100
RicPars <- matrix(NA, ntrials, 4)

for (i in 1:ntrials) {
  SimData <- Sim_Ricker_SR_Data(leng=50, age=4, Sig_Ricker = 0.76, true_a = 1.93, true_b=1/159744, 
                              hr_min = 0.25, hr_max = 0.35,  lnorm_corr = T)
  SimDataDF <- data.frame(S = round(SimData$S), R = (SimData$R), Year = 1:length(SimData$S))
  
  
  # Create DF to store true and fitted values
  DataDF <- SimDataDF[, c("S", "R", "Year")]
  DataDF$Fit <- SimData$true_a * DataDF$S * exp( -SimData$true_b * DataDF$S ) 
  DataDF$Mod <- "True"
  DataDF$CI_low <- DataDF$CI_up  <-  DataDF$Pred <- DataDF$Pred_low <- DataDF$Pred_up <- DataDF$Fit
  
  # run using TMB, with prior
  TMBstan_Prior <- RunRicker(Data = SimDataDF, 
                            Fitting_SW = "tmbstan", 
                            Priors = T, BiasCorr=T, Name = "TMBstan_Prior")
  Ests_quant <- apply ( as.data.frame(TMBstan_Prior$Ests) , 2, quantile, probs = c(0.025, 0.5, 0.975) )
  logA <- as.data.frame(Ests_quant)$logA[2] # median
  logSmax <- as.data.frame(Ests_quant)$logSmax[2] # median
  logSigma <- as.data.frame(Ests_quant)$logSigma[2] # median
  RicPars[i,] <- c(logA, logSmax, logSigma, TMBstan_Prior$Scale)  
}

colnames(RicPars) <- c("logA", "logSmax", "logSigma", "Scale")
write.csv(RicPars, "RicParsS2.csv")


```

```{r echo = FALSE, warning = FALSE}
# Set up data frame of Ricker paramters for all MC trials

RicPars <- read.csv("RicParsS2.csv")
RicPars <- as.data.frame(RicPars)
RicPars <- RicPars %>% mutate(Smax = exp(logSmax)*Scale) 

# Tune simulations by remove all MC trials with productivity less than 1 (logA < 0)

RicPars <- RicPars %>% filter(logA >= 0)
ntrialsTuned <- length (RicPars$logA)

# Calculate predicted recruitments for all MC trials along a range of spawner abundances
S <- NA
Rpred <- matrix(NA, 2000, ntrialsTuned)

for (i in 1:ntrialsTuned) {
  for (j in 1:2000){ #Assuming true smax ~ 100,000, and plot extends to 2 x Smax
    S[j] <- j*100
    Rpred[j,i] <-  exp( RicPars$logA[i] ) * S[j] * exp( -S[j] / RicPars$Smax[i] )
  }
}

# Calculate 5th, 50th, and 95th percentiles of the distribution of recruitment along
# the range of spawner abundances

Rpred_dist <- apply(Rpred, 1, quantile, probs = c(0.025, 0.5, 0.975))
Rpred_mean <- apply(Rpred, 1, mean) 


# Create a dataframe of these percentiles
EstAgg <- data.frame(S=S, Fit=Rpred_dist[2,], CI_low=Rpred_dist[1,], CI_up = Rpred_dist[3,])
EstAgg$Mod <- "TMBstan_Prior"

All_Ests <- bind_rows(DataDF, EstAgg)

# Now plot all to compare 
ggplot(data = All_Ests, aes(x=S, y=Fit, ymin = CI_low, ymax = CI_up, col = Mod, fill= Mod)) +
  geom_line(size = 1.5) +
  geom_ribbon( alpha = 0.1) +
  #geom_point(aes(x=S, y=R), col = "black") +
  scale_color_discrete(name = "", labels = c("Estimator =\nBias Corr", "OM")) + 
  guides(fill = FALSE)  +
  xlab("Spawners") + 
  ylab("Recruitment") +
  xlim(0, 200000) +
  theme_bw(base_size=16)


```

These curves match again.


For __Method 2.3__, data were generated with a log-normal bias correction, but without a correction in the estimation
```{r echo = FALSE, eval=FALSE}
# This code takes 5-10 minutes to run if estimating Bayesian posteriors in tmbstan
ntrials <- 100
RicPars <- matrix(NA, ntrials, 4)

for (i in 1:ntrials) {
  SimData <- Sim_Ricker_SR_Data(leng=50, age=4, Sig_Ricker = 0.76, true_a = 1.93, true_b=1/159744, 
                              hr_min = 0.25, hr_max = 0.35, lnorm_corr = T)
  SimDataDF <- data.frame(S = round(SimData$S), R = (SimData$R), Year = 1:length(SimData$S))
  
  
  # Create DF to store true and fitted values
  DataDF <- SimDataDF[, c("S", "R", "Year")]
  DataDF$Fit <- SimData$true_a * DataDF$S * exp( -SimData$true_b * DataDF$S ) 
  DataDF$Mod <- "True"
  DataDF$CI_low <- DataDF$CI_up  <-  DataDF$Pred <- DataDF$Pred_low <- DataDF$Pred_up <- DataDF$Fit
  
  # run using TMB, without prior
  TMBstan_Prior <- RunRicker(Data = SimDataDF, 
                            Fitting_SW = "tmbstan", 
                            Priors = T, BiasCorr=F, Name = "TMBstan_Prior")
  Ests_quant <- apply ( as.data.frame(TMBstan_Prior$Ests) , 2, quantile, probs = c(0.025, 0.5, 0.975) )
  logA <- as.data.frame(Ests_quant)$logA[2] # median
  logSmax <- as.data.frame(Ests_quant)$logSmax[2] # median
  logSigma <- as.data.frame(Ests_quant)$logSigma[2] # median
  RicPars[i,] <- c(logA, logSmax, logSigma, TMBstan_Prior$Scale)  
}

colnames(RicPars) <- c("logA", "logSmax", "logSigma", "Scale")
write.csv(RicPars, "RicParsS3.csv")
```

```{r echo = FALSE, warning=FALSE}
# Set up data frame of Ricker paramters for all MC trials

RicPars <- read.csv("RicParsS3.csv")
RicPars <- as.data.frame(RicPars)
RicPars <- RicPars %>% mutate(Smax = exp(logSmax)*Scale) 

# Tune simulations by remove all MC trials with productivity less than 1 (logA < 0)

RicPars <- RicPars %>% filter(logA >= 0)
ntrialsTuned <- length (RicPars$logA)

# Calculate predicted recruitments for all MC trials along a range of spawner abundances
S <- NA
Rpred <- matrix(NA, 2000, ntrialsTuned)

for (i in 1:ntrialsTuned) {
  for (j in 1:2000){ #Assuming true smax ~ 100,000, and plot extends to 2 x Smax
    S[j] <- j*100
    Rpred[j,i] <-  exp( RicPars$logA[i] ) * S[j] * exp( -S[j] / RicPars$Smax[i] )
  }
}

# Calculate 5th, 50th, and 95th percentiles of the distribution of recruitment along
# the range of spawner abundances

Rpred_dist <- apply(Rpred, 1, quantile, probs = c(0.025, 0.5, 0.975))
Rpred_mean <- apply(Rpred, 1, mean) 


# Create a dataframe of these percentiles
EstAgg <- data.frame(S=S, Fit=Rpred_dist[2,], CI_low=Rpred_dist[1,], CI_up = Rpred_dist[3,])
EstAgg$Mod <- "TMB_No_Prior"

All_Ests <- bind_rows(DataDF, EstAgg)

# Now plot all to compare 
ggplot(data = All_Ests, aes(x=S, y=Fit, ymin = CI_low, ymax = CI_up, col = Mod, fill= Mod)) +
  geom_line(size = 1.5) +
  geom_ribbon( alpha = 0.1) +
  #geom_point(aes(x=S, y=R), col = "black") +
  #geom_ribbon(aes(x=S, y=Pred, ymin = Pred_low, ymax = Pred_up, fill= Mod), 
  #            alpha = 0.05) +
  scale_color_discrete(name = "", labels = c("Estimator =\nNo Bias Corr", "OM")) + 
  guides(fill = FALSE)  +
  xlab("Spawners") + 
  ylab("Recruitment") +
  xlim(0, 200000) +
  theme_bw(base_size=16)

```

In this method, the estimated curve is negatively biased relative to the OM. 

__Bottom line__: The method for simulating data should match the method for estimating parameters and vice versa.


Further, the estimation method for deriving recovery targets should match the approach for estimating parameters and generating data for the projections.